<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ–ç‰‡è½‰ SVG</title>
    <script src="https://cdn.jsdelivr.net/npm/imagetracerjs@1.2.6/imagetracer_v1.2.6.min.js"></script>
    <style>
        :root {
            --primary: #009688;
            --secondary: #ff5722;
            --bg: #f4f4f4;
            --card: #ffffff;
            --selected-stroke: #2196F3;
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg);
            padding: 20px;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #333;
        }
        .container {
            background: var(--card);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            max-width: 900px;
            width: 100%;
            text-align: center;
        }
        h1 { margin-top: 0; color: #333; }
        .badge {
            background: var(--secondary);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            vertical-align: middle;
        }
        
        /* è¨­å®šå€åŸŸ */
        .settings-group {
            background: #eee;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: left;
        }
        .settings-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            margin-bottom: 10px;
        }
        
        label { cursor: pointer; display: flex; align-items: center; gap: 5px; font-weight: 500;}
        select { padding: 5px 10px; border-radius: 4px; border: 1px solid #ccc; font-size: 1rem;}

        /* ä¸Šå‚³å€ */
        .upload-box {
            border: 3px dashed #ccc;
            padding: 30px;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            margin-bottom: 20px;
            background: #fafafa;
        }
        .upload-box:hover { border-color: var(--primary); background: #e0f2f1; }
        
        /* é è¦½å€ */
        .preview-area {
            display: none;
            flex-direction: column;
            gap: 20px;
            justify-content: center;
        }
        .preview-card {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 8px;
            background: #fff;
            position: relative;
        }
        
        .instructions {
            background: #e3f2fd;
            color: #0d47a1;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .canvas-container {
            height: 500px; /* åŠ å¤§é è¦½å€ */
            display: flex;
            align-items: center;
            justify-content: center;
            /* æ£‹ç›¤æ ¼èƒŒæ™¯ï¼Œæ–¹ä¾¿çœ‹é€æ˜åº¦ */
            background-image: 
                linear-gradient(45deg, #e0e0e0 25%, transparent 25%), 
                linear-gradient(-45deg, #e0e0e0 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #e0e0e0 75%), 
                linear-gradient(-45deg, transparent 75%, #e0e0e0 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px; 
            overflow: hidden;
            border: 1px solid #ccc;
            cursor: crosshair; /* æç¤ºå¯ä»¥é»æ“Š */
        }
        
        .canvas-container svg {
            max-width: 100%;
            max-height: 100%;
            width: auto; 
            height: auto;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        /* äº’å‹•æ¨£å¼ */
        /* æ­£å¸¸çš„ path (ä¿ç•™) */
        path.keep-path {
            cursor: pointer;
            transition: all 0.1s ease;
        }
        path.keep-path:hover {
            opacity: 0.8;
            stroke: var(--selected-stroke);
            stroke-width: 2px;
        }

        /* è¢«ç§»é™¤çš„ path (åŠé€æ˜) */
        path.remove-path {
            fill: #ff0000 !important; /* ç´…è‰²æç¤º */
            fill-opacity: 0.1 !important;
            stroke: #ffcccc !important;
            stroke-width: 1px !important;
            cursor: pointer;
        }
        path.remove-path:hover {
            fill-opacity: 0.4 !important; /* hoveræ™‚ç¨å¾®æ¸…æ¥šä¸€é» */
        }

        .btn {
            background: var(--primary);
            color: white;
            text-decoration: none;
            padding: 15px 30px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 1.1rem;
            display: inline-block;
            margin-top: 20px;
            border: none;
            cursor: pointer;
        }
        .btn:hover { filter: brightness(1.1); }
        .loading { display: none; margin: 10px; color: var(--primary); font-weight: bold; }
        
        .status-bar {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #666;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>SVG è½‰æ›å™¨ <span class="badge">äº’å‹•é¸å–ç‰ˆ</span></h1>
    <p>å¦‚æœä¸»é«”è¢«èª¤åˆªï¼Œè«‹ç›´æ¥é»æ“Šè©²å€åŸŸå°‡å…¶å¾©åŸã€‚</p>

    <div class="settings-group">
        <div class="settings-row">
            <strong>1. è½‰æ›æ¨¡å¼ï¼š</strong>
            <label>
                <input type="radio" name="mode" value="bw" checked> 
                é»‘ç™½è¼ªå»“ (æ¨è–¦)
            </label>
            <label>
                <input type="radio" name="mode" value="color"> 
                å½©è‰²
            </label>
        </div>

        <div class="settings-row">
            <strong>2. é è¨­éæ¿¾ (Auto Filter)ï¼š</strong>
            <select id="bgRemoveMode">
                <option value="white" selected>è‡ªå‹•éš±è—ç™½è‰²/äº®è‰²</option>
                <option value="black">è‡ªå‹•éš±è—é»‘è‰²/æ·±è‰²</option>
                <option value="none">é¡¯ç¤ºå…¨éƒ¨ (å…¨éƒ¨æ‰‹å‹•)</option>
            </select>
        </div>
    </div>

    <div class="upload-box" onclick="document.getElementById('inp').click()">
        <input type="file" id="inp" accept="image/*" style="display:none">
        <div>ğŸ“‚ é»æ“Šé€™è£¡ä¸Šå‚³åœ–ç‰‡</div>
        <div style="margin-top:5px; font-size:0.9rem; color:#888;">ä¸Šå‚³å¾Œè«‹åœ¨ä¸‹æ–¹é è¦½åœ–é€²è¡Œæ‰‹å‹•èª¿æ•´</div>
    </div>

    <div id="loading" class="loading">æ­£åœ¨é‹ç®—è·¯å¾‘ï¼Œè«‹ç¨å€™...</div>

    <div class="preview-area" id="result">
        
        <div class="instructions">
            <span>ğŸ‘† <strong>äº’å‹•æ¨¡å¼ï¼š</strong> é»æ“Šåœ–ä¸­çš„è‰²å¡Šä¾†åˆ‡æ› [ä¿ç•™] æˆ– [åˆªé™¤]ã€‚</span>
            <span style="font-size:0.8em; color:#666;">(ç´…è‰²åŠé€æ˜ = ä¸æœƒä¸‹è¼‰)</span>
        </div>

        <div class="preview-card">
            <div class="canvas-container" id="svg-wrap"></div>
        </div>
        
        <div class="status-bar">
            å·²é¸å–è·¯å¾‘æ•¸: <span id="path-count">0</span>
        </div>

        <div>
            <a id="dl-btn" class="btn" href="#">âœ… ä¸‹è¼‰ SVG (åªä¸‹è¼‰å¯è¦‹éƒ¨åˆ†)</a>
        </div>
    </div>
</div>

<script>
    // --- åƒæ•¸è¨­å®š ---
    const bwOptions = {
        colorsampling: 2,
        numberofcolors: 2, 
        mincolorratio: 0,
        colorquantcycles: 3,
        ltres: 1,
        qtres: 1,
        pathomit: 8,     
        blurradius: 5,    
        blurdelta: 20,
        stroke: false,    
        scale: 1,
        lineart: false
    };

    const colorOptions = {
        colorsampling: 2,
        numberofcolors: 16,
        ltres: 1, 
        qtres: 1,
        pathomit: 8,
        scale: 1
    };

    function getLuminance(colorStr) {
        if (!colorStr) return 255;
        const matches = colorStr.match(/\d+/g);
        if (matches && matches.length >= 3) {
            const r = parseInt(matches[0]);
            const g = parseInt(matches[1]);
            const b = parseInt(matches[2]);
            return 0.2126 * r + 0.7152 * g + 0.0722 * b;
        }
        return 128;
    }

    const inp = document.getElementById('inp');
    const result = document.getElementById('result');
    const svgWrap = document.getElementById('svg-wrap');
    const dlBtn = document.getElementById('dl-btn');
    const loading = document.getElementById('loading');
    const pathCountSpan = document.getElementById('path-count');
    
    let currentSvgEl = null; // å„²å­˜ç•¶å‰çš„ SVG DOM
    let originalFilename = "image";

    inp.addEventListener('change', function(e) {
        if(!e.target.files[0]) return;
        
        loading.style.display = 'block';
        result.style.display = 'none';

        const file = e.target.files[0];
        originalFilename = file.name.split('.')[0];
        const reader = new FileReader();

        const mode = document.querySelector('input[name="mode"]:checked').value;
        const bgMode = document.getElementById('bgRemoveMode').value;
        const currentOptions = mode === 'bw' ? bwOptions : colorOptions;

        reader.onload = function(evt) {
            const imgData = evt.target.result;
            
            setTimeout(() => {
                ImageTracer.imageToSVG(imgData, function(svgstr) {
                    processSVG(svgstr, mode, bgMode);
                }, currentOptions);
            }, 50);
        };
        reader.readAsDataURL(file);
    });

    function processSVG(svgstr, mode, bgMode) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(svgstr, "image/svg+xml");
        currentSvgEl = doc.documentElement;

        // 1. ä¿®å¾©å±¬æ€§
        const w = currentSvgEl.getAttribute('width');
        const h = currentSvgEl.getAttribute('height');
        if (!currentSvgEl.getAttribute('viewBox') && w && h) {
            currentSvgEl.setAttribute('viewBox', `0 0 ${parseFloat(w)} ${parseFloat(h)}`);
        }
        if (!currentSvgEl.getAttribute('xmlns')) {
            currentSvgEl.setAttribute('xmlns', "http://www.w3.org/2000/svg");
        }

        // 2. åˆå§‹åŒ–è·¯å¾‘ç‹€æ…‹ (Auto Filter)
        const paths = currentSvgEl.querySelectorAll('path');
        let activeCount = 0;

        paths.forEach(p => {
            const fill = p.getAttribute('fill');
            const lum = getLuminance(fill);
            let shouldHide = false;

            // æ ¹æ“šé è¨­è¨­å®šåˆ¤æ–·æ˜¯å¦éš±è—
            if (bgMode === 'white' && lum > 200) shouldHide = true;
            if (bgMode === 'black' && lum < 50) shouldHide = true;
            if (fill === 'transparent' || fill === 'none') shouldHide = true;

            if (shouldHide) {
                p.classList.add('remove-path');
            } else {
                p.classList.add('keep-path');
                // é»‘ç™½æ¨¡å¼å¼·åˆ¶è½‰é»‘
                if (mode === 'bw') p.setAttribute('fill', '#000000');
                activeCount++;
            }

            // 3. ç¶å®šé»æ“Šäº‹ä»¶
            p.onclick = function() {
                if (this.classList.contains('keep-path')) {
                    // è®Šæˆç§»é™¤ç‹€æ…‹
                    this.classList.remove('keep-path');
                    this.classList.add('remove-path');
                } else {
                    // è®Šæˆä¿ç•™ç‹€æ…‹
                    this.classList.remove('remove-path');
                    this.classList.add('keep-path');
                    // æ¢å¾©é¡è‰² (è‹¥æ˜¯é»‘ç™½æ¨¡å¼ç¢ºä¿æ˜¯é»‘)
                    if (mode === 'bw') this.setAttribute('fill', '#000000');
                }
                updatePathCount();
            };
        });

        // é¡¯ç¤ºåˆ°ç•«é¢ä¸Š
        svgWrap.innerHTML = '';
        // ç‚ºäº†è®“ CSS class ç”Ÿæ•ˆï¼Œæˆ‘å€‘ç›´æ¥æ’å…¥ DOMï¼Œè€Œä¸æ˜¯ clone
        // æ³¨æ„ï¼šé€™æ¨£ä¿®æ”¹æœƒç›´æ¥å½±éŸ¿ currentSvgElï¼Œé€™æ­£æ˜¯æˆ‘å€‘æƒ³è¦çš„
        svgWrap.appendChild(currentSvgEl);
        
        // èª¿æ•´æ¨£å¼ä»¥é©æ‡‰è¦–çª—
        currentSvgEl.style.width = '100%';
        currentSvgEl.style.height = '100%';

        updatePathCount();
        
        loading.style.display = 'none';
        result.style.display = 'flex';
    }

    function updatePathCount() {
        const count = svgWrap.querySelectorAll('path.keep-path').length;
        pathCountSpan.innerText = count;
    }

    // ä¸‹è¼‰æŒ‰éˆ•é‚è¼¯
    dlBtn.addEventListener('click', function(e) {
        if (!currentSvgEl) return;

        // 1. è¤‡è£½ç›®å‰çš„ SVG ç‹€æ…‹
        const cloneSvg = currentSvgEl.cloneNode(true);
        
        // 2. ç§»é™¤æ‰€æœ‰æ¨™è¨˜ç‚º 'remove-path' çš„å…ƒç´ 
        const toRemove = cloneSvg.querySelectorAll('.remove-path');
        toRemove.forEach(el => el.remove());

        // 3. æ¸…ç†å‰©ä¸‹çš„ class å±¬æ€§ (Bambu Studio ä¸éœ€è¦é€™äº›)
        const toClean = cloneSvg.querySelectorAll('.keep-path');
        toClean.forEach(el => el.removeAttribute('class'));
        cloneSvg.removeAttribute('style'); // ç§»é™¤ width=100%

        // 4. åºåˆ—åŒ–ä¸¦ä¸‹è¼‰
        const serializer = new XMLSerializer();
        const svgString = serializer.serializeToString(cloneSvg);
        
        const blob = new Blob([svgString], {type: "image/svg+xml;charset=utf-8"});
        const url = URL.createObjectURL(blob);
        
        this.href = url;
        this.download = originalFilename + "_edited.svg";
    });
</script>

</body>
</html>
